name: Check Godot Release

on:
  schedule:
    # Run daily at 2 AM UTC
    - cron: '0 2 * * *'
  workflow_dispatch: # Allow manual trigger

permissions:
  contents: write
  pull-requests: write

jobs:
  check-release:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Get all Godot stable releases
        id: godot-release
        run: |
          # Fetch all stable releases from Godot GitHub
          ALL_VERSIONS=$(curl -s "https://api.github.com/repos/godotengine/godot-builds/releases?per_page=100" | \
            jq -r '[.[] | select(.tag_name | contains("-stable")) | select(.prerelease == false)] | .[].tag_name' | \
            sed 's/-stable$//')

          echo "Godot stable versions: $ALL_VERSIONS"
          echo "versions<<EOF" >> $GITHUB_OUTPUT
          echo "$ALL_VERSIONS" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: Get all release tags from repository via GitHub API
        id: git-tags
        run: |
          # Fetch all release tags from the GitHub repository
          REPO_TAGS=$(curl -s "https://api.github.com/repos/poboulet/godot-docker-image/releases?per_page=100" | \
            jq -r '.[].tag_name')
          
          echo "Repository release tags:"
          echo "$REPO_TAGS"
          echo "git_tags<<EOF" >> $GITHUB_OUTPUT
          echo "$REPO_TAGS" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT
