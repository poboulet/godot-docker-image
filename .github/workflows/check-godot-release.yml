name: Check Godot Release

on:
  schedule:
    # Run daily at 2 AM UTC
    - cron: '0 2 * * *'
  workflow_dispatch: # Allow manual trigger

permissions:
  contents: write
  pull-requests: write

jobs:
  check-release:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Get all Godot stable releases
        id: godot-release
        run: |
          # Fetch all stable releases from Godot GitHub
          ALL_VERSIONS=$(curl -s "https://api.github.com/repos/godotengine/godot-builds/releases?per_page=100" | \
            jq -r '[.[] | select(.tag_name | contains("-stable")) | select(.prerelease == false)] | .[].tag_name' | \
            sed 's/-stable$//')

          echo "Godot stable versions: $ALL_VERSIONS"
          echo "versions<<EOF" >> $GITHUB_OUTPUT
          echo "$ALL_VERSIONS" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: Get all tags in the repository
        id: git-tags
        run: |
          GIT_TAGS=$(git tag)
          echo "Git tags in repo: $GIT_TAGS"
          echo "git_tags<<EOF" >> $GITHUB_OUTPUT
          echo "$GIT_TAGS" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: Find missing versions
        id: missing-versions
        run: |
          # Get versions from previous steps
          ALL_VERSIONS="${{ steps.godot-release.outputs.versions }}"
          GIT_TAGS="${{ steps.git-tags.outputs.git_tags }}"
          
          # Find versions that are in ALL_VERSIONS but NOT in GIT_TAGS
          MISSING_VERSIONS=""
          while IFS= read -r version; do
            if [ -n "$version" ] && ! echo "$GIT_TAGS" | grep -q "^${version}$"; then
              if [ -z "$MISSING_VERSIONS" ]; then
                MISSING_VERSIONS="$version"
              else
                MISSING_VERSIONS="${MISSING_VERSIONS}"$'\n'"${version}"
              fi
            fi
          done <<< "$ALL_VERSIONS"
          
          echo "Missing versions (in Godot but not in repo):"
          echo "$MISSING_VERSIONS"
          
          # Count missing versions
          if [ -n "$MISSING_VERSIONS" ]; then
            COUNT=$(echo "$MISSING_VERSIONS" | wc -l)
            echo "Found $COUNT missing version(s)"
            echo "missing_versions<<EOF" >> $GITHUB_OUTPUT
            echo "$MISSING_VERSIONS" >> $GITHUB_OUTPUT
            echo "EOF" >> $GITHUB_OUTPUT
            echo "has_missing=true" >> $GITHUB_OUTPUT
            echo "count=$COUNT" >> $GITHUB_OUTPUT
          else
            echo "No missing versions found"
            echo "has_missing=false" >> $GITHUB_OUTPUT
            echo "count=0" >> $GITHUB_OUTPUT
          fi
    